import{a as P}from"./chunk-Z6YAK4SA.js";import{A as f,Aa as Y,Ba as Z,C as r,Ca as ee,Da as ie,E as _,Ja as te,Ka as oe,O as T,Oa as $,P as M,Pa as ne,Q as B,Qa as ae,Ra as k,Ua as q,W as A,Xa as O,Ya as re,a as h,d as S,g as v,h as E,i as L,j as V,k as z,n as l,o as H,p as d,q as c,qa as R,ra as J,s as y,sa as K,t as a,ta as Q,u as n,v as C,va as j,xa as W,y as U,z as D,za as X}from"./chunk-FJQ5DNDC.js";function ue(t,i){if(t&1&&(a(0,"div",3)(1,"label"),C(2,"input",4),r(3),n()()),t&2){let e=i.$implicit;l(2),c("value",e),l(),_(" ",e," ")}}function fe(t,i){if(t&1&&(a(0,"div")(1,"label",1),r(2,"Horarios Disponibles"),n(),d(3,ue,4,2,"div",2),n()),t&2){let e=f();l(3),c("ngForOf",e.turnos)}}var w=class t{disponibilidad;turnos=[];ngOnChanges(i){i.disponibilidad&&this.disponibilidad&&this.generarTurnos()}generarTurnos(){if(this.turnos=[],!this.disponibilidad)return;let i=this.convertirATiempo(this.disponibilidad.horaInicio),e=this.convertirATiempo(this.disponibilidad.horaFin),o=this.disponibilidad.duracionTurnos,s=new Date(i);for(;s<e;){let p=new Date(s);if(p.setMinutes(s.getMinutes()+o),p<=e){let m=`De ${this.formatearHora(s)} hs a ${this.formatearHora(p)} hs`;this.turnos.push(m)}s=p}}convertirATiempo(i){let[e,o]=i.split(":").map(Number),s=new Date;return s.setHours(e,o,0,0),s}formatearHora(i){let e=i.getHours().toString().padStart(2,"0"),o=i.getMinutes().toString().padStart(2,"0");return`${e}:${o}`}static \u0275fac=function(e){return new(e||t)};static \u0275cmp=v({type:t,selectors:[["app-horarios-disponibles"]],inputs:{disponibilidad:"disponibilidad"},features:[L],decls:1,vars:1,consts:[[4,"ngIf"],[1,"info"],["class","turnos-rb",4,"ngFor","ngForOf"],[1,"turnos-rb"],["type","radio","name","turno",3,"value"]],template:function(e,o){e&1&&d(0,fe,4,1,"div",0),e&2&&c("ngIf",o.turnos.length>0)},dependencies:[T,M],styles:[".info[_ngcontent-%COMP%]{color:#ddd;font-family:ubuntu;margin-bottom:5px}.turnos-rb[_ngcontent-%COMP%]{color:#fff}"]})};function be(t,i){if(t&1&&(a(0,"option",15),r(1),n()),t&2){let e=i.$implicit;c("value",e),l(),_(" ",e," ")}}function he(t,i){t&1&&(a(0,"div")(1,"small",16),r(2,"Este campo es obligatorio."),n()())}function Ce(t,i){if(t&1&&(a(0,"option",15),r(1),n()),t&2){let e=i.$implicit;c("value",e.email),l(),_(" ",e.nombreCompleto," ")}}function _e(t,i){t&1&&(a(0,"div")(1,"small",16),r(2,"Este campo es obligatorio."),n()())}function xe(t,i){if(t&1&&(a(0,"label",17),r(1,"Especialista"),n(),a(2,"select",18)(3,"option",6),r(4,"Elige..."),n(),d(5,Ce,2,2,"option",7),n(),d(6,_e,3,0,"div",8)),t&2){let e=f();l(5),c("ngForOf",e.especialistasDisponibles),l(),c("ngIf",(e.especialista==null?null:e.especialista.hasError("required"))&&(e.especialista==null?null:e.especialista.touched))}}function Se(t,i){t&1&&(a(0,"label",17),r(1,"Especialista"),n(),a(2,"small",16),r(3,"Seleccionar especialidad."),n())}function ve(t,i){if(t&1){let e=U();a(0,"app-calendario",19),D("dateSelected",function(s){V(e);let p=f();return z(p.handleDateSelected(s))}),n()}if(t&2){let e=f();c("fechasDisponibles",e.fechasDisponiblesStrings)}}function Ee(t,i){t&1&&(a(0,"p"),r(1,"Para utilizar el calendario primero deber\xE1s aplicar un filtro"),n(),a(2,"div",20),C(3,"app-calendario"),n())}function ye(t,i){if(t&1&&C(0,"app-horarios-disponibles",14),t&2){let e=f();c("disponibilidad",e.disponibilidadSeleccionada)}}function De(t,i){t&1&&(a(0,"p"),r(1,"Para elegir un horario primero deber\xE1s elegir una fecha"),n())}var F=class t{constructor(i,e){this.alert=i;this.firestore=e}fechaSeleccionada="";form;isLoading=!1;mostrarCalendario=!1;especialidadesDisponibles;especialistasDisponibles=[];especialistaSeleccionadoEmail="";fechasDisponibles=[];disponibilidadSeleccionada=null;handleDateSelected(i){this.fechaSeleccionada=i,this.disponibilidadSeleccionada=this.fechasDisponibles.find(e=>e.fecha===i)||null}ngOnInit(){this.form=new Q({especialidad:new j("",R.required),especialista:new j("",R.required)}),this.buscarEspecialidadesDisponibles(),console.log(this.especialistasDisponibles)}buscarEspecialidadesDisponibles(){return h(this,null,function*(){let i=new Set;try{let e=$(this.firestore,"usuarios"),o=q(e,O("rol","==","Medico"));(yield k(o)).forEach(p=>{let u=p.data().especialidades||[];Array.isArray(u)&&u.forEach(g=>i.add(g))}),this.especialidadesDisponibles=Array.from(i)}catch(e){console.error("Error al obtener especialidades: ",e),this.alert.mostrarError("Error al obtener especialidades")}})}buscarEspecialistasDisponibles(){return h(this,null,function*(){let i=this.form.get("especialidad")?.value;if(this.especialistasDisponibles=[],!i)return;let e=[];try{let o=$(this.firestore,"usuarios"),s=q(o,O("rol","==","Medico"),O("especialidades","array-contains",i));(yield k(s)).forEach(m=>{let u=m.data(),g=`${u.nombre} ${u.apellido}`,b=u.email;e.push({nombreCompleto:g,email:b})}),this.especialistasDisponibles=e}catch(o){console.error("Error al obtener especialistas: ",o),this.alert.mostrarError("Error al obtener especialistas")}})}onSubmit(){return h(this,null,function*(){if(console.log("se entro al on submit"),this.form.valid){this.isLoading=!0;let i=this.form.get("especialista")?.value,e=this.especialistasDisponibles.find(o=>o.email===i);this.especialistaSeleccionadoEmail=e?e.email:"";try{this.mostrarCalendario=!0,yield this.buscarDisponibilidad()}catch{this.alert.mostrarError("Error inesperado")}finally{this.isLoading=!1}}else this.alert.mostrarError("El formulario es inv\xE1lido")})}buscarDisponibilidad(){return h(this,null,function*(){let i=this.especialistaSeleccionadoEmail,e=this.form.get("especialidad")?.value;if(!i||!e)return;let o=new Date;o.setHours(0,0,0,0);let s=new Date;s.setDate(o.getDate()+15),s.setHours(0,0,0,0);try{console.log("Especialista seleccionado:",i);let p=ne(this.firestore,`disponibilidades/${i}`),m=yield ae(p);if(m.exists()){let g=m.data()[e]||{};this.fechasDisponibles=Object.entries(g).filter(([b,x])=>{let[le,ce,pe]=b.split("-").map(Number),I=new Date(pe,ce-1,le);return I.setHours(0,0,0,0),I>=o&&I<=s}).map(([b,x])=>({especialidad:e,fecha:b,horaInicio:x.horaInicio,horaFin:x.horaFin,duracionTurnos:x.duracionTurnos})),console.log("Fechas disponibles estructuradas:",this.fechasDisponibles)}else this.alert.mostrarError("No se encontr\xF3 disponibilidad para el especialista seleccionado")}catch(p){console.error("Error al buscar disponibilidad:",p),this.alert.mostrarError("Error al buscar disponibilidad")}})}get especialidad(){return this.form.get("especialidad")}get especialista(){return this.form.get("especialista")}get fechasDisponiblesStrings(){return this.fechasDisponibles.map(i=>i.fecha)}static \u0275fac=function(e){return new(e||t)(H(re),H(oe))};static \u0275cmp=v({type:t,selectors:[["app-solicitar-turno"]],decls:31,vars:7,consts:[[1,"banner"],[1,"solicitud-turnos"],[1,"filtros-laterales"],[3,"ngSubmit","formGroup"],["for","especialidad"],["formControlName","especialidad",3,"change"],["value","","disabled","","selected",""],[3,"value",4,"ngFor","ngForOf"],[4,"ngIf"],["type","submit",3,"disabled"],[1,"turnos"],[1,"calendario"],[3,"fechasDisponibles"],[1,"horarios"],[3,"disponibilidad"],[3,"value"],[1,"error"],["for","especialista"],["formControlName","especialista"],[3,"dateSelected","fechasDisponibles"],[1,"forbidden"]],template:function(e,o){e&1&&(a(0,"section")(1,"div",0)(2,"h2"),r(3,"SOLICITAR TURNOS"),n()()(),a(4,"section",1)(5,"div",2)(6,"h3"),r(7," FILTROS "),n(),a(8,"form",3),D("ngSubmit",function(){return o.onSubmit()}),a(9,"label",4),r(10,"Especialidad"),n(),a(11,"select",5),D("change",function(){return o.buscarEspecialistasDisponibles()}),a(12,"option",6),r(13,"Elige..."),n(),d(14,be,2,2,"option",7),n(),d(15,he,3,0,"div",8)(16,xe,7,2)(17,Se,4,0),a(18,"button",9),r(19," Aplicar "),n()()(),a(20,"div",10)(21,"div",11)(22,"h3"),r(23," Seleccione una fecha "),n(),d(24,ve,1,1,"app-calendario",12)(25,Ee,4,0),n(),a(26,"div",13)(27,"h3"),r(28," Seleccione un horario "),n(),d(29,ye,1,1,"app-horarios-disponibles",14)(30,De,2,0,"p"),n()()()),e&2&&(l(8),c("formGroup",o.form),l(6),c("ngForOf",o.especialidadesDisponibles),l(),c("ngIf",(o.especialidad==null?null:o.especialidad.hasError("required"))&&(o.especialidad==null?null:o.especialidad.touched)),l(),y(o.especialistasDisponibles.length>0?16:17),l(2),c("disabled",o.form.invalid),l(6),y(o.mostrarCalendario?24:25),l(5),y(o.fechaSeleccionada!=""?29:30))},dependencies:[T,M,P,W,ee,ie,Z,J,K,X,Y,w],styles:[".solicitud-turnos[_ngcontent-%COMP%]{display:flex;flex-direction:row}.filtros-laterales[_ngcontent-%COMP%]{display:flex;flex-direction:column;flex:30%;background-color:#212121}.filtros-laterales[_ngcontent-%COMP%]   h3[_ngcontent-%COMP%]{margin-left:30px;margin-top:30px;margin-bottom:30px}form[_ngcontent-%COMP%]{margin-left:30px;display:flex;flex-direction:column}label[_ngcontent-%COMP%]{color:#ddd;font-family:ubuntu;margin-bottom:5px}select[_ngcontent-%COMP%]{background-color:#333;border:2px solid #f00;color:#fff;padding:10px;width:80%;max-width:500px;margin-bottom:10px;border-radius:5px;transition:border .3s ease;box-shadow:0 2px 5px #0000004d}select[_ngcontent-%COMP%]:focus{border:2px solid #fff;outline:none}select[_ngcontent-%COMP%]   option[_ngcontent-%COMP%]{background-color:#333;color:#fff}.error[_ngcontent-%COMP%]{color:#f33;font-size:1em;margin-top:5px}button[type=submit][_ngcontent-%COMP%]{margin-top:10px;background-color:red;border:none;color:#fff;padding:10px 20px;cursor:pointer;font-size:1em;border-radius:5px;margin-bottom:20px;max-width:150px}button[type=submit][_ngcontent-%COMP%]:hover{background-color:#c00;box-shadow:0 2px 5px #0003}button[type=submit][_ngcontent-%COMP%]:disabled{background-color:#666;cursor:not-allowed}.turnos[_ngcontent-%COMP%]{display:flex;flex-direction:row;flex:70%;margin-bottom:30px}.calendario[_ngcontent-%COMP%]{display:flex;flex-direction:column;justify-content:left;margin-left:50px}.calendario[_ngcontent-%COMP%]   h3[_ngcontent-%COMP%]{margin-top:30px;justify-content:center;align-items:center;margin-bottom:30px}.calendario[_ngcontent-%COMP%]   p[_ngcontent-%COMP%]{margin-bottom:30px}.forbidden[_ngcontent-%COMP%]{filter:brightness(.5);pointer-events:none;opacity:.7}.forbidden[_ngcontent-%COMP%]   app-calendario[_ngcontent-%COMP%]{pointer-events:none;-webkit-user-select:none;user-select:none}.horarios[_ngcontent-%COMP%]{display:flex;flex-direction:column;justify-content:left;margin-left:70px}.horarios[_ngcontent-%COMP%]   h3[_ngcontent-%COMP%]{margin-top:30px;justify-content:center;align-items:center;margin-bottom:30px}.horarios[_ngcontent-%COMP%]   p[_ngcontent-%COMP%]{margin-bottom:30px}"]})};var Te=[{path:"",component:F}],N=class t{static \u0275fac=function(e){return new(e||t)};static \u0275mod=E({type:t});static \u0275inj=S({imports:[A.forChild(Te),A]})};var se=class t{static \u0275fac=function(e){return new(e||t)};static \u0275mod=E({type:t});static \u0275inj=S({imports:[B,N,P,te]})};export{se as SolicitarTurnoModule};
